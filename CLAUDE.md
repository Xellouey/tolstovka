# CLAUDE.md

Проект: Telegram Mini App «TOLSOVKA» + бот @tolstovka39bot
Домен Mini App: https://tolsovka.vercel.app (укажет на VPS)
Язык интерфейса: русский

Цель
- Реализовать витрину-магазин как Telegram Mini App с удобной мобильной админкой, а также Telegram-бот со стартовым экраном и навигацией.
- Без кода в этом документе: зафиксированы требования, архитектура, модели данных, маршруты, API и процессы — для дальнейшей реализации.
- В приоритете Telegram Mini App: desktop-верстка не требуется; весь UX ориентирован на мобильные устройства (и для пользователей, и для админов), mobile-first макеты и поведение в рамках Telegram WebApp.

1) Согласованные требования
- Бот
  - /start: приветственное сообщение + Inline-кнопки: О нас, Все о доставке, Обратная связь, и «Назад» для возврата к старт-меню.
  - Кнопка «Каталог» (нижняя клавиатура) — открывает Mini App (web_app) на «/» (главная витрины).
  - «О нас», «Доставка», «Обратная связь» — показываются как текст внутри бота, «Назад» возвращает к старт-меню. Тексты — заглушки на этапе разработки (правятся разработкой, не из админки).
  - «Новый дроп» — это обычная категория, создаётся/удаляется через админку (без отдельной механики).
  - Менеджер для связи: @dmitriy_mityuk (можно заменить позже).
- Mini App (витрина)
  - Главная: вверху баннер(ы). По умолчанию один; при добавлении второго — карусель с перелистыванием. Баннеры кликабельные: в админке у каждого баннера указывается URL.
  - Пропорции: баннеры 12:5; карточки в каталоге 3:4 (единый размер плиток в гриде). В карточке товара — полноразмерные изображения без обрезки.
  - Категории: управляются из админки (добавление/удаление). На главной над лентой товаров — выбор категории (чипы/табы), по умолчанию «Все», при выборе фильтруется лента.
  - Лента: показывает все товары (50+ фото, быстрая прокрутка с ленивой загрузкой). Сортировка по цене (вверх/вниз).
  - Карточка товара: несколько фото (сколько загружено), цена (₽ без копеек), описание. Кнопка «Купить»: всплывающее окно с текстом «Напишите менеджеру @dmitriy_mityuk» и кнопкой «Скопировать ссылку на товар» (/p/{id}).
  - Тестовое предзаполнение (seed): добавить категории «Пиджаки», «Джинсы», «Куртки» и несколько тестовых товаров с заглушечным текстом; изображения взять из папки design (скопировать в /uploads для использования витриной).
- Админ-панель (внутри Mini App, mobile-first)
  - Маршрут входа: /admin → форма авторизации (логин/пароль; по умолчанию admin/admin). Возможность смены пароля в админке; пароль хранится безопасно (хэш), подтягивается после смены.
  - Учётка хранится в JSON (username, passwordHash, updatedAt).
  - Управление:
    - Баннеры: добавить/удалить, вкл/выкл, порядок, ссылка URL (внутренняя/внешняя).
    - Категории: добавить/удалить, ручная сортировка (поле order).
    - Товары: добавить/удалить, изменить цену/описание, загрузка нескольких фото, перетаскивание для смены порядка фото.
  - Удаление товара — жёсткое (товар исчезает из каталога).
- Дизайн
  - Цвета: фон #ffc81a, основной/текст #383b3d, дополнительный белый #ffffff. Одна цветовая схема, минимализм. Материалы — в папке design.

2) Хранение и хостинг (VPS)
- Среда: VPS (Linux), домен https://tolsovka.vercel.app указывает на VPS, TLS.
- Данные: локальная БД на сервере (рекомендуется SQLite для простоты и надёжности; без внешних провайдеров). Категории/товары/баннеры — таблицы в SQLite.
- Медиа: файлы изображений на диске VPS (например, /var/www/tolsovka/uploads или ./uploads в папке проекта). Статика отдаётся напрямую (reverse proxy) без ограничений размера на уровне приложения.
- Обновления контента: мгновенные (никаких коммитов/деплоев).

3) Архитектура (big picture)
- Telegram-бот:
  - /start: приветствие, Inline-кнопки «О нас», «Все о доставке», «Обратная связь», «Назад». «Каталог» — нижняя клавиатура (web_app), открывает Mini App на «/».
- Mini App:
  - Публичные экраны: Главная (баннеры 12:5, выбор категории, лента 3:4), Карточка товара, Контакты/статические (при необходимости).
  - Админка: /admin (+ подразделы: баннеры, категории, товары, настройки).
  - Канонические ссылки: /p/{id} для копирования в чат.
- Безопасность:
  - Проверка подписи Telegram WebApp initData на сервере.
  - Админская сессия: JWT/сессионные куки, защита админ-эндпоинтов.
  - Пароль админа хранится как хэш (bcrypt/argon2) в JSON-конфиге.

4) Модели данных (логические)
- Категория
```json path=null start=null
{
  "id": "c_shirts",           // внутренний id
  "slug": "rubashki",         // удобный URL-слуг (транслит, lower-case, -)
  "name": "Рубашки",
  "order": 10                  // ручная сортировка категорий
}
```
- Товар
```json path=null start=null
{
  "id": "p_abc123",                 // короткий id (подходит)
  "categoryId": "c_shirts",
  "title": "Рубашка XYZ",           // опционально
  "priceRub": 3990,                  // ₽ без копеек (целое число)
  "description": "100% хлопок...",
  "images": [
    "/uploads/products/p_abc123/1.jpg",
    "/uploads/products/p_abc123/2.jpg"
  ],
  "createdAt": "2025-09-17T16:00:00Z"
}
```
- Баннер
```json path=null start=null
{
  "id": "b_main_01",
  "image": "/uploads/banners/b_main_01.jpg",
  "href": "/category/rubashki",   // либо внешний URL; пусто — без перехода
  "active": true,
  "order": 1
}
```
- Админ (JSON-конфиг)
```json path=null start=null
{
  "username": "admin",
  "passwordHash": "$2b$10$...",    // хэш пароля, не хранить пароль в открытом виде
  "updatedAt": "2025-09-17T16:00:00Z"
}
```

5) Маршруты Mini App
- Публичные:
  - / — главная: баннеры (12:5) → выбор категории (чипы/табы; «Все» по умолчанию) → лента всех товаров (сетка 3:4, ленивая загрузка) → сортировка по цене ↑/↓.
  - /category/:slug — та же сетка 3:4, но отфильтрована по категории.
  - /p/:id — карточка товара (галерея, цена, описание, «Купить» → модалка с @dmitriy_mityuk + «Скопировать ссылку»).
- Админ:
  - /admin/login — вход (логин/пароль)
  - /admin — главная админки
    - /admin/banners — баннеры: загрузка, вкл/выкл, порядок, ссылка URL
    - /admin/categories — категории: добавить/удалить, ручная сортировка
    - /admin/products — товары: добавить/удалить/редактировать; загрузка нескольких фото; перетаскивание для их упорядочивания
    - /admin/settings — смена пароля админа

6) API (эскиз без кода)
- Публичные (GET):
  - GET /api/categories → список категорий (с order)
  - GET /api/products?category=slug&sort=price_asc|price_desc → список товаров
  - GET /api/product/:id → карточка товара
  - GET /api/banners → активные баннеры (с order)
- Админ (аутентификация обязательна):
  - POST /api/admin/login { username, password } → токен/сессия
  - POST /api/admin/banners { image, href, active, order }
  - PATCH /api/admin/banners/:id { ... }
  - DELETE /api/admin/banners/:id
  - POST /api/admin/categories { name, order }
  - PATCH /api/admin/categories/reorder { items: [{id, order}, ...] }
  - DELETE /api/admin/categories/:id
  - POST /api/admin/products { categoryId, title?, priceRub, description, images[] }
  - PATCH /api/admin/products/:id { ... }
  - PATCH /api/admin/products/:id/images/reorder { images: [".../1.jpg", ".../2.jpg"] }
  - DELETE /api/admin/products/:id
  - POST /api/admin/password { currentPassword, newPassword }
  - POST /api/admin/upload (multipart) → { url }  // загрузка изображений в /uploads

Примечания:
- Лимитов на размер изображений на уровне приложения не вводим (по требованию). При необходимости ограничение можно задать в reverse proxy.
- Ссылки на товары стабильны: /p/{id}.

7) Бот: сценарии и тексты-заглушки
- Стартовое меню (Inline):
  - О нас → показать заглушку «О нас» + «Назад»
  - Все о доставке → показать заглушку «Доставка» + «Назад»
  - Обратная связь → показать заглушку «Обратная связь» + «Назад»
- Кнопка «Каталог» (нижняя): открыть web_app (главная Mini App, «/»).
- Заглушки (редактируются разработкой):
  - О нас: «Толстовка — селективный штучный мерч. Следите за дропами в каталоге Mini App.»
  - Доставка: «Доставка по РФ. Условия уточняйте у менеджера в личных сообщениях перед покупкой.»
  - Обратная связь: «По вопросам и заказам — пишите @dmitriy_mityuk. Ответим оперативно.»
- «Назад» всегда возвращает к старт-меню.

8) UI/UX детали
- Mobile-first: интерфейсы ориентированы на использование внутри Telegram WebApp; десктоп-верстка не разрабатывается. Удобство на мобильных — приоритет и для пользователей, и для админов.
- Баннеры: 12:5; один — статично, несколько — карусель с индикатором.
- Категории: чипы/табы над лентой; ручная сортировка (order).
- Лента: сетка 3:4, ленивая загрузка; под каждой карточкой — цена.
- Карточка товара: галерея фото с полноразмерным показом, цена, описание, кнопка «Купить» → модалка (ссылка на менеджера + копирование ссылки /p/{id}).
- Перетаскивание фото в админке — для порядка отображения.

9) Развёртывание (VPS)
- VPS (Linux, например Ubuntu 22.04+), Node.js LTS, reverse proxy (Nginx) с TLS для https://tolsovka.vercel.app → backend.
- Статика (баннеры/товары) отдаётся напрямую через Nginx из каталога /uploads и/или /public.
- Бэкенд как сервис (systemd/pm2), переменные окружения для секретов (токен бота и т.п.).
- В BotFather добавить домен в web_app-кнопку (доверенный https-домен).

10) План работ
- Этап 1
  - Скелет Mini App: тема, маршруты, главная (баннеры + выбор категории + лента), категория, карточка.
  - Скелет админки: /admin, авторизация, заготовки разделов (баннеры/категории/товары/настройки).
  - Бот: /start меню (Inline «О нас/Доставка/Обратная связь/Назад»), нижняя «Каталог» (web_app → «/»), заглушечные тексты.
  - Тестовое наполнение (seed): предзаполнить категории «Пиджаки», «Джинсы», «Куртки» и добавить несколько тестовых товаров с заглушечным описанием; изображения использовать из папки design (скопировать в /uploads).
- Этап 2
  - Инфраструктура VPS: Node, Nginx (TLS), директории /uploads, переменные окружения.
  - Хранилище: SQLite (схемы), загрузка изображений в /uploads.
  - CRUD в админке: баннеры (URL), категории (order), товары (multi-image, drag-and-drop, жёсткое удаление).
- Этап 3
  - Публичные API (GET): категории/товары/баннеры; сортировка по цене.
  - UX-полировка: модалка «Купить», копирование ссылки, плавные переходы, ленивая загрузка.
  - Тестирование на мобильных Telegram-клиентах; пограничные сценарии (удалённый товар, пустая категория).

11) Открытые вопросы
- Нет. Все ключевые решения подтверждены: VPS, ручной order, перетаскивание фото, без лимитов, короткие id p_xxx, удобные slug-и категорий (транслит).

После вашего ОК двигаемся к реализации по плану выше (без изменения требований).
