<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>TOLSOVKA — Каталог</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root { --bg: #ffc81a; --fg: #383b3d; --white: #ffffff; --muted: #e8e8e8; }
      html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif; }
      header { padding: 12px 16px; font-weight: 700; display: flex; align-items: center; justify-content: space-between; }
      .banner { aspect-ratio: 12 / 5; width: 100%; background: var(--white); border-radius: 12px; overflow: hidden; display: none; }
      .banner img { width: 100%; height: 100%; object-fit: cover; display: block; }
      .carousel { position: relative; height: 100%; }
      .slides { display: flex; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
      .slide { flex: 0 0 100%; height: 100%; scroll-snap-align: start; }
      .dots { position: absolute; left: 0; right: 0; bottom: 6px; display: flex; gap: 6px; justify-content: center; }
      .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(0,0,0,0.2); }
      .dot.active { background: rgba(0,0,0,0.6); }
      .container { padding: 12px 12px 80px; }
      .topbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin: 12px 0; }
      .chips { display: flex; gap: 8px; overflow-x: auto; flex: 1; }
      .chip { padding: 8px 12px; background: var(--white); border-radius: 999px; white-space: nowrap; border: 1px solid transparent; }
      .chip.active { border-color: var(--fg); }
      .sort { margin-left: 8px; padding: 8px 12px; background: var(--white); border-radius: 999px; border: 1px solid transparent; }
      .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .card { background: var(--white); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
      .thumb { width: 100%; aspect-ratio: 3 / 4; background: #eee; background-size: cover; background-position: center; }
      .price { padding: 8px; font-weight: 700; }
      /* Product view */
      .hidden { display: none !important; }
      .product { padding: 12px; }
      .product .gallery { display: flex; flex-direction: column; gap: 8px; }
      /* Свайп-галерея товара */
      .pslides { display: flex; gap: 0; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; border-radius: 12px; background: var(--white); }
      .pslide { flex: 0 0 100%; scroll-snap-align: start; }
      .pslide img { width: 100%; height: auto; display: block; }
      .pdots { display: flex; gap: 6px; justify-content: center; }
      .pdot { width: 6px; height: 6px; border-radius: 50%; background: rgba(0,0,0,0.2); }
      .pdot.active { background: rgba(0,0,0,0.6); }
      .thumbs { display: flex; gap: 8px; overflow-x: auto; }
      .thumbs img { height: 72px; border-radius: 8px; background: var(--white); outline: 2px solid transparent; }
      .thumbs img.active { outline-color: var(--fg); }
      .title { font-size: 18px; font-weight: 700; margin-top: 8px; }
      .desc { margin-top: 4px; line-height: 1.35; }
      .price-lg { margin-top: 8px; font-size: 18px; font-weight: 800; }
      .buybar { position: fixed; left: 0; right: 0; bottom: 0; background: var(--fg); color: var(--white); padding: 12px 16px; display: flex; gap: 8px; }
      .btn { appearance: none; -webkit-appearance: none; border: 0; border-radius: 10px; padding: 12px 14px; font-weight: 700; }
      .btn.primary { background: var(--white); color: var(--fg); flex: 1; }
      .btn.secondary { background: transparent; color: var(--white); border: 1px solid var(--white); }
      /* Modal */
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
      .modal .sheet { background: var(--white); border-radius: 12px; padding: 16px; width: calc(100% - 32px); max-width: 420px; color: var(--fg); }
      .modal .sheet h3 { margin: 0 0 8px 0; }
      .modal .actions { display: flex; gap: 8px; margin-top: 12px; }
      .modal .actions a, .modal .actions button { flex: 1; text-align: center; padding: 12px; border-radius: 10px; text-decoration: none; font-weight: 700; }
      .modal .actions a { background: var(--fg); color: var(--white); }
      .modal .actions button { background: var(--bg); color: var(--fg); border: 1px solid var(--fg); }
      .back { color: var(--fg); text-decoration: none; font-weight: 600; }
      .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 72px; background: rgba(0,0,0,0.8); color: #fff; padding: 10px 14px; border-radius: 999px; font-size: 14px; }
      .toast.hidden { display: none; }
    </style>
  </head>
  <body>
    <header>
      <a href="#" class="back" id="backLink" style="visibility:hidden">← Назад</a>
      <div>TOLSOVKA</div>
      <div style="width:40px"></div>
    </header>

    <div class="container">
      <div class="banner" id="banner"></div>
      <div class="topbar">
        <div class="chips" id="chips"></div>
        <button class="sort" id="sortBtn">Цена ↑</button>
      </div>
      <div class="grid" id="grid"></div>

      <div class="product hidden" id="productView">
        <div class="gallery">
          <div class="main-img">
            <div class="pslides" id="prodSlides"></div>
          </div>
          <div class="pdots" id="prodDots"></div>
          <div class="thumbs" id="prodThumbs"></div>
        </div>
        <div class="title" id="prodTitle"></div>
        <div class="price-lg" id="prodPrice"></div>
        <div class="desc" id="prodDesc"></div>
      </div>
    </div>

    <div class="buybar hidden" id="buybar">
      <button class="btn secondary" id="copyLink">Скопировать ссылку</button>
      <button class="btn primary" id="openBuy">Купить</button>
    </div>

    <div class="modal" id="buyModal">
      <div class="sheet">
        <h3>Как купить</h3>
        <div>Напишите менеджеру <b>@dmitriy_mityuk</b>. Приложите ссылку на товар — её можно скопировать.</div>
        <div class="actions">
          <a href="https://t.me/dmitriy_mityuk" target="_blank" rel="noopener">Написать менеджеру</a>
          <button id="copyFromModal">Скопировать ссылку</button>
        </div>
        <div style="margin-top:8px; text-align:center">
          <button class="btn secondary" id="closeModal">Закрыть</button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast hidden">Ссылка скопирована</div>

    <script>
      const state = {
        categories: [],
        products: [],
        sort: 'price_asc',
        activeCategory: null, // slug | null
      };

      const els = {
        banner: document.getElementById('banner'),
        chips: document.getElementById('chips'),
        grid: document.getElementById('grid'),
        sortBtn: document.getElementById('sortBtn'),
        backLink: document.getElementById('backLink'),
        productView: document.getElementById('productView'),
        prodSlides: document.getElementById('prodSlides'),
        prodDots: document.getElementById('prodDots'),
        prodThumbs: document.getElementById('prodThumbs'),
        prodTitle: document.getElementById('prodTitle'),
        prodPrice: document.getElementById('prodPrice'),
        prodDesc: document.getElementById('prodDesc'),
        buybar: document.getElementById('buybar'),
        buyModal: document.getElementById('buyModal'),
        copyLink: document.getElementById('copyLink'),
        openBuy: document.getElementById('openBuy'),
        closeModal: document.getElementById('closeModal'),
        copyFromModal: document.getElementById('copyFromModal'),
      };

      function isProductRoute() { return /^\/p\/.+/.test(location.pathname); }
      function getProductIdFromPath() { return location.pathname.split('/').pop(); }
      function isCategoryRoute() { return /^\/category\/.+/.test(location.pathname); }
      function getCategorySlugFromPath() { return location.pathname.split('/').pop(); }

      async function fetchJSON(url) {
        const r = await fetch(url, { credentials: 'same-origin' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      }

      async function loadCategories() {
        const cats = await fetchJSON('/api/categories');
        state.categories = cats;
        renderChips();
      }

      function renderChips() {
        els.chips.innerHTML = '';
        const allChip = document.createElement('button');
        allChip.className = 'chip' + (state.activeCategory ? '' : ' active');
        allChip.textContent = 'Все';
        allChip.onclick = () => navigateTo('/');
        els.chips.appendChild(allChip);

        state.categories.forEach(c => {
          const b = document.createElement('button');
          b.className = 'chip' + (state.activeCategory === c.slug ? ' active' : '');
          b.textContent = c.name;
          b.onclick = () => navigateTo(`/category/${c.slug}`);
          els.chips.appendChild(b);
        });
      }

      async function loadProducts() {
        const qs = new URLSearchParams();
        if (state.activeCategory) qs.set('category', state.activeCategory);
        if (state.sort) qs.set('sort', state.sort);
        const url = '/api/products' + (qs.toString() ? ('?' + qs.toString()) : '');
        const prods = await fetchJSON(url);
        state.products = prods;
        renderGrid();
      }

      function renderGrid() {
        els.grid.innerHTML = '';
        if (!state.products.length) {
          const empty = document.createElement('div');
          empty.style.cssText = 'padding:16px; text-align:center; opacity:0.7;';
          empty.textContent = 'Здесь пока пусто';
          els.grid.parentElement.insertBefore(empty, els.grid.nextSibling);
          return;
        }
        const nextSib = els.grid.nextSibling;
        if (nextSib && nextSib.nodeType === 1 && nextSib.textContent === 'Здесь пока пусто') nextSib.remove();
        state.products.forEach(p => {
          const el = document.createElement('a');
          el.className = 'card';
          el.href = `/p/${p.id}`;
          const img = (p.images && p.images[0]) ? p.images[0] : '';
          el.innerHTML = `
            <div class="thumb" style="background-image:url('${img}')"></div>
            <div class="price">${p.priceRub} ₽</div>
          `;
          el.addEventListener('click', (ev) => { ev.preventDefault(); navigateTo(el.href); });
          els.grid.appendChild(el);
        });
      }

      async function renderProduct(id) {
        try {
          const p = await fetchJSON('/api/product/' + encodeURIComponent(id));
          // Show product view
          els.grid.classList.add('hidden');
          els.productView.classList.remove('hidden');
          els.buybar.classList.remove('hidden');
          els.backLink.style.visibility = 'visible';

          els.prodTitle.textContent = p.title || '';
          els.prodPrice.textContent = `${p.priceRub} ₽`;
          els.prodDesc.textContent = p.description || '';

          const imgs = Array.isArray(p.images) && p.images.length ? p.images : [''];
          // Build slides
          els.prodSlides.innerHTML = imgs.map((src) => `<div class="pslide"><img src="${src}" alt="" /></div>`).join('');
          // Build dots
          els.prodDots.innerHTML = imgs.map((_,i)=>`<div class="pdot${i===0?' active':''}"></div>`).join('');
          // Build thumbs
          els.prodThumbs.innerHTML = imgs.map((src, i) => `<img src="${src}" data-idx="${i}" alt="" class="${i===0?'active':''}" />`).join('');
          const slidesEl = els.prodSlides;
          const dotsEls = Array.from(els.prodDots.children);
          const thumbImgs = Array.from(els.prodThumbs.querySelectorAll('img'));
          function setActive(idx) {
            dotsEls.forEach((d,i)=>d.classList.toggle('active', i===idx));
            thumbImgs.forEach((t,i)=>t.classList.toggle('active', i===idx));
          }
          slidesEl.addEventListener('scroll', () => {
            const w = slidesEl.clientWidth;
            const i = Math.round(slidesEl.scrollLeft / Math.max(1,w));
            setActive(i);
          });
          thumbImgs.forEach((img,i)=>{
            img.addEventListener('click', () => {
              slidesEl.scrollTo({ left: i * slidesEl.clientWidth, behavior: 'smooth' });
              setActive(i);
            });
          });

          // Wire buy actions
          const prodUrl = window.location.origin + '/p/' + p.id;
          function showToast(text) {
            const t = document.getElementById('toast');
            t.textContent = text || 'Ссылка скопирована';
            t.classList.remove('hidden');
            setTimeout(()=> t.classList.add('hidden'), 1500);
          }
          els.copyLink.onclick = async () => {
            await navigator.clipboard.writeText(prodUrl);
            if (navigator.share) {
              // опционально можно шарить
            }
            showToast('Ссылка скопирована');
          };
          els.copyFromModal.onclick = els.copyLink.onclick;
          els.openBuy.onclick = () => { els.buyModal.style.display = 'flex'; };
          els.closeModal.onclick = () => { els.buyModal.style.display = 'none'; };
        } catch (e) {
          console.error(e);
          navigateTo('/');
        }
      }

      function showCatalogView() {
        els.productView.classList.add('hidden');
        els.buybar.classList.add('hidden');
        els.grid.classList.remove('hidden');
        els.backLink.style.visibility = 'hidden';
      }

      function navigateTo(url) {
        history.pushState({}, '', url);
        route();
      }

      async function loadBannersPublic() {
        try {
          const banners = await fetchJSON('/api/banners');
          if (Array.isArray(banners) && banners.length > 0) {
            els.banner.style.display = 'block';
            if (banners.length === 1) {
              const b = banners[0];
              els.banner.innerHTML = b.href ? `<a href="${b.href}"><img src="${b.image}" alt="" /></a>` : `<img src="${b.image}" alt="" />`;
            } else {
              // Carousel
              const slides = banners.map(b => `<div class=\"slide\">${b.href ? `<a href=\"${b.href}\"><img src=\"${b.image}\" alt=\"\" /></a>` : `<img src=\"${b.image}\" alt=\"\" />`}</div>`).join('');
              els.banner.innerHTML = `<div class=\"carousel\"><div class=\"slides\" id=\"slides\">${slides}</div><div class=\"dots\" id=\"dots\"></div></div>`;
              const slidesEl = document.getElementById('slides');
              const dotsEl = document.getElementById('dots');
              dotsEl.innerHTML = banners.map((_,i)=>`<div class=\"dot${i===0?' active':''}\"></div>`).join('');
              const dots = Array.from(dotsEl.children);
              let idx = 0;
              slidesEl.addEventListener('scroll', () => {
                const w = slidesEl.clientWidth;
                const x = slidesEl.scrollLeft;
                const i = Math.round(x / w);
                if (i !== idx) {
                  dots[idx]?.classList.remove('active');
                  dots[i]?.classList.add('active');
                  idx = i;
                }
              });
            }
          } else {
            els.banner.style.display = 'none';
          }
        } catch (e) {
          els.banner.style.display = 'none';
        }
      }

      async function route() {
        // Banner
        await loadBannersPublic();

        if (isProductRoute()) {
          const id = getProductIdFromPath();
          await renderProduct(id);
          return;
        }

        // catalog routes
        showCatalogView();
        if (isCategoryRoute()) {
          state.activeCategory = getCategorySlugFromPath();
        } else {
          state.activeCategory = null;
        }
        renderChips();
        await loadProducts();
      }

      window.onpopstate = route;

      // Sorting toggle
      els.sortBtn.onclick = async () => {
        state.sort = (state.sort === 'price_asc') ? 'price_desc' : 'price_asc';
        els.sortBtn.textContent = state.sort === 'price_asc' ? 'Цена ↑' : 'Цена ↓';
        if (!isProductRoute()) await loadProducts();
      };

      // Init
      (async () => {
        try {
          await loadCategories();
          await route();
        } catch (e) { console.error(e); }
      })();
    </script>
  </body>
</html>
